"""
Script para cargar datos de prueba en la base de datos
"""

import sys
import os
sys.path.insert(0, os.path.abspath(os.path.join(os.path.dirname(__file__), '..')))

import bcrypt
from datetime import datetime, timedelta
from app.database import get_db_connection

def hash_password(password):
    """Hashea una contrase√±a usando bcrypt"""
    return bcrypt.hashpw(password.encode('utf-8'), bcrypt.gensalt(12)).decode('utf-8')

def seed_data():
    """Inserta datos de prueba en todas las tablas"""
    
    conn = get_db_connection()
    cursor = conn.cursor()
    
    try:
        print("üå± Insertando datos de prueba...\n")
        
        # ---------------------------------------------------------
        # 1. Insertar roles
        # ---------------------------------------------------------
        print("üìã Insertando roles...")
        roles_data = [
            ('admin', 'Administrador del sistema con acceso total'),
            ('teacher', 'Profesor que puede gestionar cursos y asignaciones'),
            ('student', 'Estudiante que puede inscribirse en cursos'),
            ('administrative', 'Personal administrativo con acceso limitado')
        ]
        
        cursor.executemany(
            "INSERT INTO roles (name, description) VALUES (%s, %s) ON DUPLICATE KEY UPDATE description=VALUES(description)",
            roles_data
        )
        # IMPORTANTE: Guardar cambios para poder leerlos inmediatamente despu√©s
        conn.commit() 
        print(f"  ‚úÖ {len(roles_data)} roles insertados")
        
        # Obtener IDs de roles
        cursor.execute("SELECT id, name FROM roles")
        roles_rows = cursor.fetchall()
        
        # Validaci√≥n de seguridad: Verificar que se insertaron roles
        if not roles_rows:
            raise Exception("No se pudieron recuperar los roles insertados.")

        roles = {name.encode('utf-8'): id for id, name in roles_rows}
        
        # ---------------------------------------------------------
        # 2. Insertar usuarios
        # ---------------------------------------------------------
        print("üë• Insertando usuarios...")
        users_data = [
            ('admin', 'admin@academic.com', hash_password('Admin123!'), roles['admin']),
            ('teacher1', 'teacher1@academic.com', hash_password('Teacher123!'), roles['teacher']),
            ('teacher2', 'teacher2@academic.com', hash_password('Teacher123!'), roles['teacher']),
            ('student1', 'student1@academic.com', hash_password('Student123!'), roles['student']),
            ('student2', 'student2@academic.com', hash_password('Student123!'), roles['student']),
            ('student3', 'student3@academic.com', hash_password('Student123!'), roles['student']),
            ('admin_staff', 'admin.staff@academic.com', hash_password('Admin123!'), roles['administrative'])
        ]
        
        cursor.executemany(
            """INSERT INTO users (username, email, password_hash, role_id) 
               VALUES (%s, %s, %s, %s) 
               ON DUPLICATE KEY UPDATE email=VALUES(email)""",
            users_data
        )
        conn.commit() # Guardar usuarios antes de buscarlos para cursos
        print(f"  ‚úÖ {len(users_data)} usuarios insertados")
        
        # Obtener IDs de usuarios
        cursor.execute("SELECT id, username FROM users")
        users = {username: id for id, username in cursor.fetchall()}
        
        # ---------------------------------------------------------
        # 3. Insertar cursos
        # ---------------------------------------------------------
        print("üìö Insertando cursos...")
        courses_data = [
            ('Matem√°ticas Avanzadas', 'C√°lculo diferencial e integral', 'MATH301', users['teacher1']),
            ('Programaci√≥n Web', 'Desarrollo de aplicaciones web modernas', 'CS201', users['teacher1']),
            ('Base de Datos', 'Dise√±o e implementaci√≥n de bases de datos', 'CS301', users['teacher2']),
            ('F√≠sica General', 'Mec√°nica cl√°sica y termodin√°mica', 'PHYS101', users['teacher2'])
        ]
        
        cursor.executemany(
            """INSERT INTO courses (name, description, code, teacher_id) 
               VALUES (%s, %s, %s, %s)
               ON DUPLICATE KEY UPDATE name=VALUES(name)""",
            courses_data
        )
        conn.commit() # Guardar cursos antes de buscarlos para asignaciones
        print(f"  ‚úÖ {len(courses_data)} cursos insertados")
        
        # Obtener IDs de cursos
        cursor.execute("SELECT id, code FROM courses")
        courses = {code: id for id, code in cursor.fetchall()}
        
        # ---------------------------------------------------------
        # 4. Insertar asignaciones
        # ---------------------------------------------------------
        print("üìù Insertando asignaciones...")
        due_date_1 = (datetime.now() + timedelta(days=7)).strftime('%Y-%m-%d %H:%M:%S')
        due_date_2 = (datetime.now() + timedelta(days=14)).strftime('%Y-%m-%d %H:%M:%S')
        
        assignments_data = [
            ('Tarea 1: Derivadas', 'Resolver ejercicios de derivadas parciales', 
             courses['MATH301'], due_date_1, 100.00),
            ('Proyecto Final: Calculadora', 'Implementar calculadora cient√≠fica', 
             courses['MATH301'], due_date_2, 150.00),
            ('Lab 1: HTML y CSS', 'Crear p√°gina web responsive', 
             courses['CS201'], due_date_1, 80.00),
            ('Proyecto: Sistema CRUD', 'Desarrollar aplicaci√≥n web completa', 
             courses['CS201'], due_date_2, 200.00),
            ('Tarea 1: Normalizaci√≥n', 'Ejercicios de formas normales', 
             courses['CS301'], due_date_1, 100.00),
            ('Examen: Cinem√°tica', 'Examen de movimiento rectil√≠neo', 
             courses['PHYS101'], due_date_1, 120.00)
        ]
        
        cursor.executemany(
            """INSERT INTO assignments (title, description, course_id, due_date, max_score) 
               VALUES (%s, %s, %s, %s, %s)""",
            assignments_data
        )
        print(f"  ‚úÖ {len(assignments_data)} asignaciones insertadas")
        
        # ---------------------------------------------------------
        # 5. Insertar inscripciones
        # ---------------------------------------------------------
        print("üéì Insertando inscripciones...")
        enrollments_data = [
            (users['student1'], courses['MATH301']),
            (users['student1'], courses['CS201']),
            (users['student2'], courses['CS201']),
            (users['student2'], courses['CS301']),
            (users['student3'], courses['PHYS101']),
            (users['student3'], courses['MATH301'])
        ]
        
        cursor.executemany(
            """INSERT INTO enrollments (student_id, course_id) 
               VALUES (%s, %s)
               ON DUPLICATE KEY UPDATE enrolled_at=CURRENT_TIMESTAMP""",
            enrollments_data
        )
        print(f"  ‚úÖ {len(enrollments_data)} inscripciones insertadas")
        
        conn.commit()
        
        # Mostrar resumen
        print("\n" + "=" * 50)
        print("‚ú® ¬°Datos de prueba insertados exitosamente!")
        print("=" * 50)
        print("\nüìä Resumen:")
        print(f"  ‚Ä¢ {len(roles_data)} roles")
        print(f"  ‚Ä¢ {len(users_data)} usuarios")
        print(f"  ‚Ä¢ {len(courses_data)} cursos")
        print(f"  ‚Ä¢ {len(assignments_data)} asignaciones")
        print(f"  ‚Ä¢ {len(enrollments_data)} inscripciones")
        
        print("\nüîê Credenciales de prueba:")
        print("  Admin:    admin / Admin123!")
        print("  Teacher:  teacher1 / Teacher123!")
        print("  Student:  student1 / Student123!")
        print("  Staff:    admin_staff / Admin123!")
        
    except Exception as e:
        conn.rollback()
        print(f"\n‚ùå Error al insertar datos: {str(e)}")
        # Imprimir traceback completo para debugging
        import traceback
        traceback.print_exc()
        raise
    finally:
        cursor.close()
        conn.close()

if __name__ == '__main__':
    print("=" * 50)
    print("  Carga de Datos de Prueba")
    print("=" * 50)
    seed_data()